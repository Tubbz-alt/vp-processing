# Extract vp data {#extract-vp}

```{r extract_rmd_settings, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

In this chapter we'll select, read, combine, filter and export data from vp files to a single, unaggregated CSV file.

```{r extract_load_libraries, results="hide"}
library(bioRad)
library(dplyr)
library(lubridate)
source("functions/vp_to_df.R")
source("functions/load_settings.R")
```

## Load settings

All of the filtering options we'll use here are defined in **yaml settings file**, which we pointed to in `setup.Rmd` (see \@ref(#settings)). Let's load those:

```{r extract_load_settings}
settings <- load_settings(settings_file)
```

## Select date range & radars

Select vp files on the date range and radars we defined in our settings (_horizontal_selection_):

```{r extract_get_file_paths}
vp_file_paths <- bioRad::retrieve_vp_paths(
  start_date = settings$general$tart_date,
  end_date = settings$general$end_date,
  radar = settings$general$radar_ids_3char,
  path = raw_data_dir
)
```

The file paths we get back only start from the data directory, so we need to append those with the path to the data directory itself:

```{r extract_complete_file_paths}
vp_file_paths <- paste0(raw_data_dir, vp_file_paths)
```

There are **`r length(vp_file_paths)` vp files** that meet our criteria. Preview:

```{r extract_preview_file_paths}
head(vp_file_paths, 5)
```

## Read vp files

We read all those files with bioRad. This could take a while:

```{r extract_read_vp_data_get_â˜•}
vp_files <- bioRad::readvp.list(vp_file_paths)
```

## Select variables

A single vp file contains a data frame with heights as rows and variables as columns: 

```{r extract_show_vp_data_structure}
str(vp_files[[1]]$data)
```

We only select the variables (`HGHT`, `u`, `v`, `dens`, `sd_vpp`) and attributes (`date_time` and `radar_id`) we need (_vertical selection_). We retrieve those with the custom function `vp_to_df.R` after which we combine all data in one single data frame, sorted on `radar_id`, `date_time`, and `HGHT`:

```{r extact_select_columns_and_sort}
vp_data = list()
for (i in seq_along(vp_files)) {
  vp_data[[i]] <- vp_to_df(vp_files[[i]])
}
dplyr::bind_rows(vp_data) %>%
dplyr::arrange(radar_id, date_time, HGHT) -> vp_data
```

That data frame contains **`r nrow(vp_data)` records**. Preview:

```{r extract_vp_data_preview}
head(vp_data)
```

## Filter out specific heights

...

## Filter out specific dates

...

## Export to a CSV file

Finally, we export the data to a CSV file:

```{r extract_vp_export}
write.csv(vp_data, file = "../data/interim/vp_data.csv", na = "", row.names = FALSE)
```

_Note: the data frame `vp_data` contains `NaN` and `NA` values, [which have a different meaning](https://github.com/enram/timamp-etl/issues/10#issuecomment-302235736). That difference gets lost in the CSV file: all are treated as blank (= `NA`) values, which is fine for visualizations. If you want to keep that difference, you need work further with `vp_data`._
